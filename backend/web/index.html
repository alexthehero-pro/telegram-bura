<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bura Game</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { background:#121212; color:white; font-family:Arial; margin:0; padding:16px; }
    .card { background:#1e1e1e; padding:12px; border-radius:12px; margin-bottom:12px; }
    .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
    button { padding:12px 16px; font-size:16px; border:0; border-radius:10px; }
    .btn { background:#00aaff; color:white; }
    .small { opacity:.8; font-size:14px; }
    .hand button { min-width:70px; }
  </style>
</head>
<body>

  <div class="card">
    <div id="hello">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="small" id="info"></div>
  </div>

  <div class="card">
    <div><b>–¢–≤–æ–π —Ö–æ–¥</b></div>
    <div class="row hand" id="hand"></div>
    <div class="row" style="margin-top:10px;">
      <button class="btn" onclick="newRound()">üîÑ –ù–æ–≤—ã–π —Ä–∞—É–Ω–¥</button>
    </div>
  </div>

  <div class="card">
    <div><b>–°—Ç–æ–ª</b></div>
    <div class="row">
      <div>–¢—ã: <span id="myCard">‚Äî</span></div>
      <div>–ë–æ—Ç: <span id="botCard">‚Äî</span></div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div>–°—á—ë—Ç: <span id="score">0 : 0</span></div>
      <div>–ö–æ–∑—ã—Ä—å: <span id="trump">‚Äî</span></div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;

  if (tg) {
    tg.expand();
    const u = tg.initDataUnsafe?.user;
    document.getElementById("hello").textContent =
      u ? `–ü—Ä–∏–≤–µ—Ç, ${u.first_name}! üëã` : "–ü—Ä–∏–≤–µ—Ç! üëã";
    document.getElementById("info").textContent =
      u ? `id: ${u.id} | coins: ...` : "–û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –∏–∑ Telegram (—ç—Ç–æ –æ–∫ –¥–ª—è —Ç–µ—Å—Ç–∞).";
  } else {
    document.getElementById("hello").textContent = "–û—Ç–∫—Ä—ã—Ç–æ –Ω–µ –∏–∑ Telegram (—ç—Ç–æ –æ–∫).";
    document.getElementById("info").textContent = "";
  }

  const API_BASE = "";

  async function apiMe() {
    try {
      const initData = tg?.initData || "";
      const res = await fetch(`${API_BASE}/api/me`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ initData })
      });

      const data = await res.json();
      console.log("ME:", data);

      if (data.ok) {
        // –æ–±–Ω–æ–≤–∏–º —Å—Ç—Ä–æ–∫—É info –∏ –ø–æ–∫–∞–∂–µ–º –º–æ–Ω–µ—Ç—ã
        const info = document.getElementById("info");
        info.textContent = `id: ${data.user.tg_id} | coins: ${data.user.coins}`;
      } else {
        document.getElementById("info").textContent = "API error: " + JSON.stringify(data);
      }
    } catch (e) {
      document.getElementById("info").textContent = "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ API: " + e;
    }
  }

  apiMe();
</script>

  // --- –ú–∏–Ω–∏-–ª–æ–≥–∏–∫–∞ (–ø–æ–∫–∞ —É–ø—Ä–æ—â—ë–Ω–Ω–æ) ---
  const suits = ["‚ô†","‚ô•","‚ô¶","‚ô£"];
  const ranks = ["6","7","8","9","10","J","Q","K","A"]; // –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è "–±—É—Ä–∞" 36 –∫–∞—Ä—Ç
  const rankPower = Object.fromEntries(ranks.map((r,i)=>[r,i])); // 6 —Å–ª–∞–±–∞—è, A —Å–∏–ª—å–Ω–∞—è

  let hand = [];
  let trumpSuit = null;
  let myScore = 0;
  let botScore = 0;

  function randomCard() {
    const r = ranks[Math.floor(Math.random()*ranks.length)];
    const s = suits[Math.floor(Math.random()*suits.length)];
    return {r, s};
  }

  function cardToText(c){ return `${c.r}${c.s}`; }

  function newRound() {
    myScore = 0; botScore = 0;
    trumpSuit = suits[Math.floor(Math.random()*suits.length)];
    document.getElementById("trump").textContent = trumpSuit;
    hand = [randomCard(), randomCard(), randomCard()];
    renderHand();
    clearTable();
    renderScore();
  }

  function renderHand() {
    const el = document.getElementById("hand");
    el.innerHTML = "";
    hand.forEach((c, idx) => {
      const b = document.createElement("button");
      b.className = "btn";
      b.textContent = cardToText(c);
      b.onclick = () => playCard(idx);
      el.appendChild(b);
    });
  }

  function clearTable() {
    document.getElementById("myCard").textContent = "‚Äî";
    document.getElementById("botCard").textContent = "‚Äî";
  }

  function renderScore() {
    document.getElementById("score").textContent = `${myScore} : ${botScore}`;
  }

  function compareCards(my, bot) {
    // –£–ø—Ä–æ—â—ë–Ω–Ω–æ:
    // 1) –∫–æ–∑—ã—Ä—å –±—å—ë—Ç –Ω–µ-–∫–æ–∑—ã—Ä—å
    // 2) –µ—Å–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –º–∞—Å—Ç—å ‚Äî —Å—Ç–∞—Ä—à–µ –ø–æ —Ä–∞–Ω–≥—É
    const myTrump = my.s === trumpSuit;
    const botTrump = bot.s === trumpSuit;

    if (myTrump && !botTrump) return 1;
    if (!myTrump && botTrump) return -1;

    if (my.s === bot.s) {
      if (rankPower[my.r] > rankPower[bot.r]) return 1;
      if (rankPower[my.r] < rankPower[bot.r]) return -1;
      return 0;
    }

    // —Ä–∞–∑–Ω–∞—è –º–∞—Å—Ç—å –∏ –æ–±–∞ (–Ω–µ)–∫–æ–∑—ã—Ä—å ‚Üí –ø—É—Å—Ç—å –≤—ã–∏–≥—Ä—ã–≤–∞–µ—Ç —Ç–æ—Ç, –∫—Ç–æ —Ö–æ–¥–∏–ª (—Ç—ã)
    return 1;
  }

  function playCard(idx) {
    const my = hand.splice(idx,1)[0];
    const bot = randomCard();

    document.getElementById("myCard").textContent = cardToText(my);
    document.getElementById("botCard").textContent = cardToText(bot);

    const res = compareCards(my, bot);
    if (res >= 0) myScore += 1; else botScore += 1;

    renderScore();
    renderHand();

    // –µ—Å–ª–∏ –∫–∞—Ä—Ç—ã –∫–æ–Ω—á–∏–ª–∏—Å—å ‚Äî –∞–≤—Ç–æ–Ω–æ–≤—ã–π —Ä–∞—É–Ω–¥ (–ø–æ–∑–∂–µ —Å–¥–µ–ª–∞–µ–º ‚Äú–ø–∞—Ä—Ç–∏—é‚Äù)
    if (hand.length === 0) {
      setTimeout(() => {
        alert(myScore > botScore ? "–¢—ã –≤—ã–∏–≥—Ä–∞–ª —Ä–∞—É–Ω–¥! üèÜ" : "–ë–æ—Ç –≤—ã–∏–≥—Ä–∞–ª —Ä–∞—É–Ω–¥ ü§ñ");
        newRound();
      }, 150);
    }
  }

  newRound();
</script>
</body>
</html>

